// slack-demo.js
(function(){
  // Wait until the page is ready (safer for Carrd)
  function ready(fn){ /in/.test(document.readyState) ? setTimeout(()=>ready(fn), 9) : fn(); }

  ready(function(){
    const ASSETS = {
      carlosAvatar:"https://raw.githubusercontent.com/MrPhilphiliberto/assets/refs/heads/main/ChatGPT%20Image%20Jul%2028%2C%202025%2C%2005_10_59%20PM.png",
      corr:   "https://raw.githubusercontent.com/MrPhilphiliberto/assets/refs/heads/main/plot_phase1_turn1.png",
      hist:   "https://raw.githubusercontent.com/MrPhilphiliberto/assets/refs/heads/main/plot_phase5_turn22.png",
      scatter:"https://raw.githubusercontent.com/MrPhilphiliberto/assets/refs/heads/main/plot_phase7_turn30.png",
      forecast:"https://raw.githubusercontent.com/MrPhilphiliberto/assets/refs/heads/main/forecastor_pseudo.png"
    };

    // Two scenarios in same #carlos channel
    const SCENARIOS = [
      {
        channel:"#carlos",
        script:[
          { from:"sam",    ts:"6:04 PM",
            text:'<span class="mention">@Carlos ‚Äì Dark Wave</span> can you evaluate drivers of performance on our total conversion volume?' },
          { from:"carlos", ts:"6:04 PM", text:"On it. I'll be right back with my findings." },
          { from:"carlos", ts:"6:05 PM",
            text:"Currently, Brand Search and Social tactics are driving conversions, while acquisition costs are climbing in Programmatic, suppressing our total conversion count." },
          { from:"carlos", ts:"6:06 PM",
            text:"Here‚Äôs the distribution and correlation matrix, with a fairly accurate regression model fit. I'd recommend that we evaluate shifting budget into top performing tactics. Would you like a full budget optimization recommendation?",
            attachments:[
              {url:ASSETS.hist,   caption:"Histogram: Total Conversions"},
              {url:ASSETS.corr,   caption:"Correlation Matrix"},
              {url:ASSETS.scatter,caption:"Predicted vs Actual Conversions"}
            ]}
        ]
      },
      {
        channel:"#carlos",
        script:[
          { from:"priya",  ts:"9:12 AM",
            text:'<span class="mention">@Carlos ‚Äì Dark Wave</span> can you run a weekly performance roll-up by tactic bucket and show CPA trends?' },
          { from:"carlos", ts:"9:12 AM",
            text:"Running the analytics assistant‚Ä¶ selecting the best-matching tactic bucket, aggregating weekly & monthly, and computing rolling CPAs." },
          { from:"carlos", ts:"9:13 AM",
            text:`<div class="code-block">üìä Performance Summary: All Tactics
üìÖ Week of 08/17/2025:
- Spend: $128,000
- Total Checkout Starts: 4,210
- Total Conversions: 1,980
- CPA: $56.70
  ‚Ü≥ vs 3W MA: $54.10 (‚Üë 4.8%)
  ‚Ü≥ vs 6W MA: $53.40 (‚Üë 6.2%)
  ‚Ü≥ vs 12W MA: $55.20 (‚Üë 2.7%)

üí° Top 5 Tactics by Conversion Volume This Week (62% of Total Spend):
1. Brand Search Exact ‚Äî Conversions: 1,120 ‚Äî Spend: $34,200 ‚Äî CPA: $30.54
2. Paid Social Prospecting ‚Äî Conversions: 890 ‚Äî Spend: $27,000 ‚Äî CPA: $30.34
3. Brand Search Broad ‚Äî Conversions: 620 ‚Äî Spend: $14,700 ‚Äî CPA: $23.71
4. Site Retargeting ‚Äî Conversions: 410 ‚Äî Spend: $12,500 ‚Äî CPA: $30.49
5. Programmatic Contextual ‚Äî Conversions: 345 ‚Äî Spend: $9,600 ‚Äî CPA: $27.83

üìÖ Monthly Summary (August 2025):
- Spend: $502,000
- Total Checkout Starts: 16,420
- Total Conversions: 7,980
- CPA: $58.90
  ‚Ü≥ vs 3M MA: $56.40 (‚Üë 4.4%)
  ‚Ü≥ vs 6M MA: $55.90 (‚Üë 5.4%)
‚ò†Ô∏èüëª Performance Decomposition by Tactic Bucket: (abridged)
- Brand Search: 34.2% Checkout Starts, 36.9% Conversions, 31.5% Spend, CPA: $31.40
- Paid Social: 28.0% Checkout Starts, 26.4% Conversions, 27.1% Spend, CPA: $34.60
- Programmatic: 18.5% Checkout Starts, 17.2% Conversions, 20.3% Spend, CPA: $41.10
</div>` },
          { from:"sam",    ts:"9:14 AM",
            text:"Nice. Let‚Äôs forecast next week for the top tactic that you just identified." },
          { from:"carlos", ts:"9:15 AM",
            text:`<div class="code-block">üîÆ Forecast using 3W moving-average spend (exogenous):
Tactic Selected: Brand Search Exact

- Total Checkout Starts (t+1): 1,160.4
- Total Conversions (t+1): 610.7
- Avg Cost to Acquire (CPA): $29.85
Forecast week of 08/24/2025.</div>`,
            attachments:[
              {url:ASSETS.forecast, caption:"Forecast vs Fitted (t+1)"},
              {url:ASSETS.corr,     caption:"Model Diagnostics (AIC-min SARIMAX)"}
            ] },
          { from:"priya",  ts:"9:15 AM",
            text:"Perfect. Please prep a budget shift +10% to Brand Search Exact and draft a channel note." }
        ]
      }
    ];

    const mounts = document.querySelectorAll(".slack-demo");
    if(!mounts.length) return;

    mounts.forEach(mount=>{
      // Static shell
      mount.innerHTML = [
        '<div class="sd-sidebar">',
          '<div class="sd-org">ü™ê</div>',
          '<div class="sd-nav">',
            '<h4>Channels</h4>',
            '<div class="sd-item active"><span class="sd-ic"></span><span class="sd-chan-label">#carlos</span></div>',
            '<div class="sd-item"><span class="sd-ic"></span><span>#all-dark-wave</span></div>',
            '<h4>Apps</h4>',
            '<div class="sd-item"><span class="sd-ic"></span><span>Slackbot</span></div>',
            '<div class="sd-item"><span class="sd-ic"></span><span>Carlos ‚Äì Dark Wave</span></div>',
          '</div>',
        '</div>',
        '<div class="sd-header">',
          '<div class="sd-dots"><span class="sd-dot"></span><span class="sd-dot"></span><span class="sd-dot"></span></div>',
          '<span class="sd-header-title">#carlos ‚Ä¢ Dark Wave Marketing Science</span>',
        '</div>',
        '<div class="sd-body">',
          '<div class="sd-scroll"></div>',
          '<button class="jump-bottom" title="Jump to latest" aria-label="Jump to latest">',
            '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">',
              '<path fill-rule="evenodd" d="M1.5 5.5l6 6 6-6H1.5z"/>',
            '</svg>',
          '</button>',
        '</div>'
      ].join('');

      const scroll       = mount.querySelector(".sd-scroll");
      const jump         = mount.querySelector(".jump-bottom");
      const chanLabel    = mount.querySelector(".sd-chan-label");
      const headerTitle  = mount.querySelector(".sd-header-title");

      // Jump-to-bottom (no auto-scroll)
      function isAtBottom(){ return (scroll.scrollHeight - (scroll.scrollTop + scroll.clientHeight)) < 24; }
      function updateJump(){ isAtBottom() ? jump.classList.remove("show") : jump.classList.add("show"); }
      function smoothToBottom(){
        const start = scroll.scrollTop;
        const end   = scroll.scrollHeight - scroll.clientHeight;
        const dur   = 600, t0 = performance.now();
        function anim(t){
          const p = Math.min((t - t0)/dur, 1);
          scroll.scrollTop = start + (end - start) * p;
          if(p < 1) requestAnimationFrame(anim); else updateJump();
        }
        requestAnimationFrame(anim);
      }
      jump.addEventListener("click", smoothToBottom);
      scroll.addEventListener("scroll", updateJump);

      // Thread reply counter (per scenario)
      let replyCount = 0, dividerEl = null, dividerLabelEl = null;
      function resetThread(){ replyCount=0; dividerEl=null; dividerLabelEl=null; }
      function ensureDivider(){
        if(dividerEl) return;
        dividerEl = document.createElement("div");
        dividerEl.className = "thread-break";
        dividerLabelEl = document.createElement("div");
        dividerLabelEl.className = "reply-count";
        dividerLabelEl.textContent = "1 reply";
        const line = document.createElement("div"); line.className = "thread-line";
        dividerEl.appendChild(dividerLabelEl); dividerEl.appendChild(line);
        scroll.appendChild(dividerEl);
        updateJump();
      }
      function updateDivider(){
        if(!dividerEl) return;
        dividerLabelEl.textContent = (replyCount===1) ? "1 reply" : `${replyCount} replies`;
      }

      const avatar = who=>{
        const el = document.createElement("div"); el.className="avatar";
        if(who==="carlos"){
          const img = document.createElement("img");
          img.src = ASSETS.carlosAvatar; img.alt = "Carlos ‚Äì Dark Wave";
          el.appendChild(img);
        } else {
          el.textContent = (who==="sam") ? "S" : (who==="priya" ? "P" : "?");
        }
        return el;
      };

      function addMsg(item){
        // Divider + counter only for Carlos
        if(item.from==="carlos"){
          if(!dividerEl){ replyCount = 1; ensureDivider(); updateDivider(); }
          else { replyCount += 1; updateDivider(); }
        }

        const row = document.createElement("div");
        row.className = "msg from-"+item.from;
        row.appendChild( avatar(item.from) );

        const content = document.createElement("div"); content.className="msg-content";
        const head = document.createElement("div"); head.className="head";
        const nm = document.createElement("span"); nm.className="name";
        nm.textContent = item.from==="carlos" ? "Carlos ‚Äì Dark Wave"
                      : item.from==="sam"    ? "Sam T."
                      : item.from==="priya"  ? "Priya N."
                      : item.from;
        head.appendChild(nm);
        if(item.from==="carlos"){
          const app = document.createElement("span"); app.className="app-badge"; app.textContent="APP";
          head.appendChild(app);
        }
        const meta = document.createElement("span"); meta.className="meta"; meta.textContent=item.ts||"";
        head.appendChild(meta);

        const p = document.createElement("p"); p.className="body-text"; p.innerHTML=item.text;
        content.appendChild(head); content.appendChild(p);

        if(item.attachments){
          item.attachments.forEach(a=>{
            const card = document.createElement("div"); card.className="attach";
            const img  = document.createElement("img");
            img.loading="lazy"; img.src=a.url; img.alt=a.caption||"Attachment";
            const cap  = document.createElement("div"); cap.className="attach-cap"; cap.textContent=a.caption||"";
            card.appendChild(img); card.appendChild(cap); content.appendChild(card);
          });
        }

        row.appendChild(content); scroll.appendChild(row);
        requestAnimationFrame(()=> row.classList.add("show"));
        updateJump();
      }

      // Sequenced playback: Scenario 1 then Scenario 2
      const MESSAGE_DELAY = 3000;
      const BETWEEN_SCENARIOS_DELAY = 1200;
      const REFRESH_DELAY = 6000;

      let scenarioIndex = 0, msgIndex = 0, started = false;

      function setChannelUI(channel){
        chanLabel.textContent = channel;
        headerTitle.textContent = `${channel} ‚Ä¢ Dark Wave Marketing Science`;
      }

      function playNextMessage(){
        const scenario = SCENARIOS[scenarioIndex];
        if(msgIndex >= scenario.script.length){
          setTimeout(()=>{
            scroll.innerHTML = "";
            resetThread();
            msgIndex = 0;

            scenarioIndex = (scenarioIndex + 1) % SCENARIOS.length;
            const nextScenario = SCENARIOS[scenarioIndex];
            setChannelUI(nextScenario.channel);

            const pause = (scenarioIndex === 0) ? REFRESH_DELAY : BETWEEN_SCENARIOS_DELAY;
            setTimeout(playNextMessage, pause);
          }, BETWEEN_SCENARIOS_DELAY);
          return;
        }
        addMsg(scenario.script[msgIndex++]);
        setTimeout(playNextMessage, MESSAGE_DELAY);
      }

      function startIfVisible(){
        if(started) return;
        started = true;
        setChannelUI(SCENARIOS[scenarioIndex].channel);
        playNextMessage();
      }

      if("IntersectionObserver" in window){
        const io = new IntersectionObserver((entries)=>{
          entries.forEach(e=>{
            if(e.isIntersecting && e.intersectionRatio >= 0.35){
              startIfVisible();
              io.disconnect();
            }
          });
        }, {threshold:[0,0.2,0.35,0.6,1]});
        io.observe(mount);
      } else {
        setTimeout(startIfVisible, 1000);
      }
    });
  });
})();
